name: Rust

on:
  push:
    branches:
      - master

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    name: Build Napture (Ubuntu)
    runs-on: ubuntu-24.04

    steps:
    - uses: actions/checkout@v4
    - name: Install Dependencies
      run: |
        echo "Installing dependencies..."
        sudo apt-get update
        sudo apt-get install -y libglib2.0-dev libcairo2-dev libgraphene-1.0-dev libgtk-4-dev libadwaita-1-dev 
        sudo add-apt-repository universe
        sudo apt install libfuse2
        echo "Dependencies installed."

    - name: Build Napture
      run: |
        echo "Building Napture..."
        cd napture
        export PKG_CONFIG_PATH=/usr/lib/pkgconfig
        cargo build --release
        echo "Napture built successfully."
    - name: Install AppImageTool
      run: |
        echo "Starting artifact upload phase..."
        echo "Installing AppImageTool..."
        wget https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
        chmod +x appimagetool-x86_64.AppImage
        echo "AppImageTool installed."
    - name: Create Napture AppImage
      run: |
        echo "Creating Napture AppImage..."
        cd napture
        mkdir -p AppDir/usr/bin
        cp target/release/webx AppDir/usr/bin/
        cp io.github.face_hh.Napture.desktop AppDir/
        cp io.github.face_hh.Napture.svg AppDir/
        ARCH=x86_64
         ../appimagetool-x86_64.AppImage AppDir
        mv Napture-x86_64.AppImage ../Bussin.Napture-x86_64.AppImage
        echo "AppImage created successfully."
    - name: Rename AppImage
      run: |
        echo "Renaming AppImage..."
        mv Bussin.Napture-x86_64.AppImage napture-v${{ github.sha }}.AppImage
        echo "AppImage renamed successfully."

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: napture-v${{ github.sha }}.AppImage
        path: napture-v${{ github.sha }}.AppImage
      env:
        UPLOAD_URL: ${{ steps.upload.outputs.upload_url }}
  build_win:
    runs-on: windows-latest
    name: Build Napture (Windows)

    steps:
    - uses: actions/checkout@v2
    
    - name: Install Inno Setup
      run: |
        echo "Downloading Inno Setup..."
        Invoke-WebRequest -Uri 'https://jrsoftware.org/download.php/is.exe' -OutFile 'C:\is.exe'
        echo "Installing Inno Setup..."
        Start-Process -Wait -FilePath 'C:\is.exe' -ArgumentList '/VERYSILENT /NORESTART'
        echo "Inno Setup installed."
    - name: Install Rust with GNU target
      run: |
        rustup toolchain install stable-gnu 
        rustup default stable-gnu
    - name: Download and install MSYS2
      run: |
        Invoke-WebRequest -Uri 'https://repo.msys2.org/distrib/x86_64/msys2-x86_64-20240507.exe' -OutFile 'C:\msys2-x86_64.exe'
        Start-Process -Wait -FilePath 'C:\msys2-x86_64.exe' -ArgumentList '/VERYSILENT /NORESTART'
        
    - name: Run MSYS2 Commands
      run: |
        C:\msys64\mingw32.exe pacman -Syu
        C:\msys64\mingw32.exe pacman -S mingw-w64-x86_64-toolchain base-devel mingw-w64-x86_64-gtk4 mingw-w64-x86_64-gettext mingw-w64-x86_64-libxml2 mingw-w64-x86_64-librsvg mingw-w64-x86_64-pkgconf mingw-w64-x86_64-gcc mingw-w64-x86_64-libadwaita mingw-w64-x86_64-lua
        $env:PATH += ";C:\msys64\mingw64\include;C:\msys64\mingw64\bin;C:\msys64\mingw64\lib"
   
    - name: Build Napture
      run: |
        echo "Building Napture..."
        cd napture
        cargo build --release
        echo "Napture built successfully."
      
    - name: Create Installer
      run: |
        echo "Creating Installer..."
        cd installer
        & 'C:\Program Files\Inno Setup 6\ISCC.exe' setup.iss
        echo "Installer created successfully."
      
    - name: Upload Artifact
      uses: actions/upload-artifact@v2
      with:
        name: NaptureWindowsSetup.exe
        path: installer\setup.exe
  upload:
   name: "Upload Release"
   runs-on: ubuntu-24.04
   needs:
      - build
      - build_win
   steps:
      - name: Download Ubuntu Artifact
        uses: actions/download-artifact@v4.1.7
        with:
          name: napture-v${{ github.sha }}.AppImage
      - name: Download Windows Artifact
        uses: actions/download-artifact@v2
        with:
          name: NaptureWindowsSetup.exe
      - name: Download Dependencies
        run: |
            sudo add-apt-repository universe
            sudo apt install libfuse2
      - name: Publish AppImage to Releases
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_CONTINUOUS_RELEASE_NAME: "Automatic Build (${{ github.sha }})"
          GITHUB_CONTINUOUS_RELEASE_TAG: "workflow-build-${{ github.sha }}"
        run: |
            wget -q https://github.com/TheAssassin/pyuploadtool/releases/download/continuous/pyuploadtool-x86_64.AppImage
            chmod +x pyuploadtool-x86_64.AppImage
            ./pyuploadtool-x86_64.AppImage napture-v${{ github.sha }}.AppImage* NaptureWindowsSetup.exe
